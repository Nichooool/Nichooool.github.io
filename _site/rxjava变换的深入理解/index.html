<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>RxJava 对于’变换‘的理解 &#8211; Nichool</title> <meta name="description" content="Rx思想 - 一切操作皆‘变换’"> <meta name="keywords" content="blog, rxjava"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="head.jpg"> <meta name="twitter:title" content="RxJava 对于’变换‘的理解"> <meta name="twitter:description" content="Rx思想 - 一切操作皆‘变换’"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="RxJava 对于’变换‘的理解"> <meta property="og:description" content="Rx思想 - 一切操作皆‘变换’"> <meta property="og:url" content="https://nichooool.github.io//rxjava%E5%8F%98%E6%8D%A2%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/"> <meta property="og:site_name" content="Nichool"> <meta property="og:image" content="https://nichooool.github.io//images/head.jpg"> <link rel="canonical" href="https://nichooool.github.io//rxjava%E5%8F%98%E6%8D%A2%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="https://nichooool.github.io//feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="https://nichooool.github.io//favicon.png" /> <link rel="shortcut icon" href="https://nichooool.github.io//favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="https://nichooool.github.io//assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(https://nichooool.github.io//images/unsplash-gallery-image-3.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(https://nichooool.github.io//images/unsplash-image-10.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(https://nichooool.github.io//images/home.png) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="https://nichooool.github.io/" class="logo"><img src="https://nichooool.github.io//images/head.jpg"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">RxJava 对于’变换‘的理解 </h1> <ul class="tags"> <li><a href="https://nichooool.github.io//tags#blog">blog</a></li> <li><a href="https://nichooool.github.io//tags#rxjava">rxjava</a></li> </ul> <div class="section-line reverse"><a href="https://nichooool.github.io//posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="share-buttons"> <a href="https://twitter.com/intent/tweet?text=https://nichooool.github.io//rxjava%E5%8F%98%E6%8D%A2%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://nichooool.github.io//rxjava%E5%8F%98%E6%8D%A2%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=https://nichooool.github.io//rxjava%E5%8F%98%E6%8D%A2%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> </div> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a title="projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">26 May 2017</div> <h3 id="rxjava-rxjava">RxJava 对于”变换”的理解（RxJava真正的核心）</h3> <blockquote> <p>RxJava中常用的”变换”</p> </blockquote> <p>RxJava中的所有的操作 <code class="highlighter-rouge">map</code>、<code class="highlighter-rouge">flatMap</code>、<code class="highlighter-rouge">groupBy</code>、<code class="highlighter-rouge">scan</code>、<code class="highlighter-rouge">concat</code>等等 (这些操作方法的具体使用请看另一篇文章) 都是一种”变换”。为了更好地实现复杂的链式操作，我们就需要来好好解析下它的工作原理了。</p> <blockquote> <p>RxJava”变换”的原理</p> </blockquote> <p>这是<code class="highlighter-rouge">map()</code>的源码(源码版本为RxJava1.1.6)，其中调用了”变换”的核心方法<code class="highlighter-rouge">left()</code>，我们先来分析下这段代码：</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">//Observable.java</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">(</span><span class="n">Func1</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="err">，</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">func</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">lift</span><span class="o">(</span><span class="k">new</span> <span class="n">OperatorMap</span><span class="o">&lt;</span><span class="n">T</span><span class="err">，</span> <span class="n">R</span><span class="o">&gt;(</span><span class="n">func</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">lift</span><span class="o">(</span><span class="kd">final</span> <span class="n">Operator</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">R</span><span class="err">，</span> <span class="o">?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">return</span> <span class="k">new</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">OnSubscribeLift</span><span class="o">&lt;</span><span class="n">T</span><span class="err">，</span> <span class="n">R</span><span class="o">&gt;(</span><span class="n">onSubscribe</span><span class="err">，</span> <span class="n">operator</span><span class="o">));</span>
<span class="o">}</span>

<span class="c1">//OnSubscribeLift.java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="p">(</span><span class="n">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">st</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="na">onLift</span><span class="o">(</span><span class="n">operator</span><span class="o">).</span><span class="na">call</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// new Subscriber created and being subscribed with so 'onStart' it</span>
            <span class="n">st</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>
            <span class="n">parent</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="n">st</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// localized capture of errors rather than it skipping all operators</span>
            <span class="c1">// and ending up in the try/catch of the subscribe method which then</span>
            <span class="c1">// prevents onErrorResumeNext and other similar approaches to error handling</span>
            <span class="n">Exceptions</span><span class="o">.</span><span class="na">throwIfFatal</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="n">st</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Exceptions</span><span class="o">.</span><span class="na">throwIfFatal</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="c1">// if the lift function failed all we can do is pass the error to the final Subscriber</span>
        <span class="c1">// as we don't have the operator available to us</span>
        <span class="n">o</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div> <p>通过上面的源码我们可以得知”变换”<code class="highlighter-rouge">left()</code>的流程如下（有些代码没有列出，此处不再赘述，感兴趣的朋友可以去Github上详细看下）： 通过<code class="highlighter-rouge">hook.onLift(operator)</code>执行封装的操作，通过<code class="highlighter-rouge">call()</code>传入原始<code class="highlighter-rouge">Subscriber</code>然后封装成新的<code class="highlighter-rouge">Subscriber</code>，然后通知父<code class="highlighter-rouge">Observable</code>来处理这个新的<code class="highlighter-rouge">Subscriber</code>。</p> <p>简述: 1. 创建一个新的<code class="highlighter-rouge">Observable</code>（被观察者） - 新的<code class="highlighter-rouge">Observable</code>的<code class="highlighter-rouge">call()</code>中 a. 通过<code class="highlighter-rouge">Operator</code>来创建一个新的<code class="highlighter-rouge">Subscriber</code>（观察者）。 b. 调用父<code class="highlighter-rouge">Observable</code>的<code class="highlighter-rouge">call</code>方法通知它对新创建的<code class="highlighter-rouge">Subscriber</code>进行处理。</p> <p>我们通过下面的一个例子来理解下整个链式操作的流程：</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="n">Observable</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="s">"hello"</span><span class="err">，</span> <span class="s">"my"</span><span class="err">，</span> <span class="s">"name"</span><span class="err">，</span> <span class="s">"is"</span><span class="err">，</span> <span class="s">"nichool"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="k">new</span> <span class="n">Func1</span><span class="o">&lt;</span><span class="n">String</span><span class="err">，</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="n">call</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">"map: "</span> <span class="o">+</span> <span class="n">s</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="k">new</span> <span class="n">Func1</span><span class="o">&lt;</span><span class="n">String</span><span class="err">，</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="n">call</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">"map1: "</span> <span class="o">+</span> <span class="n">s</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="k">new</span> <span class="n">Action1</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="n">call</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LogUtils</span><span class="o">.</span><span class="na">LogW</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
</code></pre></div> <p><strong>先预想下将会打印的Log是什么！！</strong>.</p> <p>我们来一步一步分析，上面的代码可以分成下面这几个流程：</p> <p><img src="../images/rxjava/Implementation_process.png" alt="流程图" /></p> <p>执行流程时序图中(A)操作: 也就是刚才的<code class="highlighter-rouge">left()</code>的简述</p> <p>时序图(B)操作：<code class="highlighter-rouge">Observable2.subscribe()</code>将注册的<code class="highlighter-rouge">Subscriber</code>传入并调用<code class="highlighter-rouge">call()</code>，开始通知流程</p> <p><img src="../images/rxjava/Notification_process.png" alt="流程图" /></p> <p>通知流程时序图中操作： (C) : 调用Observable2.call() - ( 就是<code class="highlighter-rouge">left()</code>中<code class="highlighter-rouge">call</code>方法）生成新的Subscriber subscriber2 然后调用Observable1.call(); (D) : 调用Observable1.call() - 生成 subscriber1，调用 Observable.call(); (E) : 调用Observable.call() - 将封装了所有操作的subscriber1传入call方法中，开始发送流程</p> <p><img src="../images/rxjava/Send_the_process.png" alt="流程图" /></p> <p>发送流程时序图中操作： (F) : 调用subscriber1 中的onNext 等方法 (I) : 调用subscriber2 中的onNext 等方法 (J) : 调用subscriber(此处为上面代码中的subscribe()方法中的Subscriber) 中的onNext 等方法</p> <p>整个流程合起来的流程图 <a href="https://gank.io/post/560e15be2dca930e00da1083#toc_15">下图来源</a> <img src="../images/rxjava/rxjava1.jpg" alt="流程图" /></p> <p>这是结果的Log</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="nl">RxJavaDemo:</span> <span class="nl">map1:</span> <span class="nl">map:</span> <span class="n">hello</span>
<span class="nl">RxJavaDemo:</span> <span class="nl">map1:</span> <span class="nl">map:</span> <span class="n">my</span>
<span class="nl">RxJavaDemo:</span> <span class="nl">map1:</span> <span class="nl">map:</span> <span class="n">name</span>
<span class="nl">RxJavaDemo:</span> <span class="nl">map1:</span> <span class="nl">map:</span> <span class="n">is</span>
<span class="nl">RxJavaDemo:</span> <span class="nl">map1:</span> <span class="nl">map:</span> <span class="n">nichool</span>
</code></pre></div> <blockquote> <p>总结</p> </blockquote> <p>RxJava中”变换”的核心就是将<strong>操作</strong>封装成新的观察者，多个”变换“的链式操作也就是多个观察者与被观察者相互通知与处理的流程，整个RxJava项目通过这种代理的思想来实现复杂的逻辑。(<em>真心厉害！！！</em>)</p> <p><strong>本文的分析将非常有助于线程调度方面的理解！！</strong></p> <br> <a href="https://twitter.com/intent/tweet?text=https://nichooool.github.io//rxjava%E5%8F%98%E6%8D%A2%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://nichooool.github.io//rxjava%E5%8F%98%E6%8D%A2%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=https://nichooool.github.io//rxjava%E5%8F%98%E6%8D%A2%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> <nav class="pagination"> <a href="https://nichooool.github.io//rxjava%E4%BB%8B%E7%BB%8D/" class="pagination_pager" title="RxJava介绍 ">previous</a> <a href="https://nichooool.github.io//rxjava%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6%E7%9A%84%E7%90%86%E8%A7%A3/" class="pagination_pager" title="RxJava 的线程控制使用与原理 ">next</a> </nav> </div> </div> <!-- JS --> <script src="https://nichooool.github.io//assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://taylantatli.me/Halve/images/halve-home-image.png) center center no-repeat;"> <a href="http://taylantatli.me/Halve" class="inactive" target="_blank" rel="nofollow external"> <span> Halve Jekyll Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://cloud.githubusercontent.com/assets/754514/14509720/61c61058-01d6-11e6-93ab-0918515ecd56.png) center center no-repeat;"> <a href="http://taylantatli.me/Moon" target="_blank" rel="nofollow external"> <span> Moon Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Ramme/master/assets/img/screenshot-post.png) center center no-repeat;"> <a href="http://taylantatli.me/Ramme" target="_blank" rel="nofollow external"> <span> Ramme Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Daisy-Pelican-Theme/master/Preview-1.png) center center no-repeat;"> <a href="http://taylantatli.me/Daisy-Pelican-Theme/" target="_blank" rel="nofollow external"> <span> Daisy Pelican Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Block-Icon-Theme/master/Preview.png) center center no-repeat;"> <a href="https://github.com/TaylanTatli/Block-Icon-Theme" class="inactive" target="_blank" rel="nofollow external"> <span> Block Icon Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/StartPage/master/preview.png) center center no-repeat;"> <a href="http://taylantatli.me/StartPage/" class="inactive" target="_blank" rel="nofollow external"> <span> Start Page <br><em>in progress</em> </span> </a> </li> </ul> </div> </body> </html>
